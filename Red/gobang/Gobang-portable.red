Red[
	title: "Gobang"
	Needs: 'View
]

;判定记录棋谱文件夹是否存在，不存在则创建
;if ( not exists? %./record/ ) [ make-dir %./record/ ]
;黑白子图像
black-chess: make image! [30x30 #{
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000F0F0F0B4B4B4AEADAE797979969696B4B4B4D6D6D7000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000D6D6D6
69696A20202000000000000000000000000000000010110C3E3F39A4A5A2
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000FFFFFF777776010100
0000000707041A1B141A1B131E1E161F1E171E1D161A1912000000000000
393739CAC6CA000000000000000000000000000000000000000000000000
000000000000000000000000000000000000FFFFFF4546410000000D0F09
1C1D171C1D171C1D171D1F1921201A241F1B23201B24201C27231E25221D
0100000200009E9B9B000000000000000000000000000000000000000000
000000000000000000000000000000FFFFFF3B3B3A0000001A1B161C1D18
1C1D181E1F1A1F201A21221C24231D26221D27241F27241F26231F27241E
2A2720141009000000B6B7B8000000000000000000000000000000000000
0000000000000000000000000000006F6F690000001A1B161B1D18201E19
221F1A23201B26231E26231E2825202A2621292621292621292621292621
2926202D292314130C0E0F09E7E7E8000000000000000000000000000000
000000000000000000000000D7D7D800000011120A1C1D191D1E1922201B
25211C26221D2926212926212B28232C29242C29242C29242D2A252D2A25
2C29242D29242E2C250002005B5C5D000000000000000000000000000000
0000000000000000000000005757560000001E1F181D1D181F201B24221D
27231E2825202B28232D2A252E2B262E2B26302D28322F2A33302B33302B
302D282F2B272D2B25262821080707D5D4D4000000000000000000000000
000000000000000000E6E6E50B0C070E100A1F1E19211D1823201B26231E
2825202B28232D2A25302D28322F2A34312C35322D36332E37342F37342F
35322D35322D322F2B322F2A02000083827B000000000000000000000000
000000000000000000A4A4A40000001C1E191F1F1A24201B26231E292621
2B28232D2A25312E2934312C36332E3835303B38333C39343A37323C3934
3C393438353037342F34312C1916114C4C45FAFBF6000000000000000000
0000000000000000007E7E7F0000001D1E1921201B26221D26231E292621
2D2A25302D2834312C36332E3936313D3A353F3C37413E39413E39413E39
3F3C373E3B353A373236332E27231F3B3B34E4E5DF000000000000000000
0000000000000000004444430000001D1F1922211B27231E2825202B2823
2E2B26322F2A36332E3936313E3B36423F3A423F3A46433E47443F46433E
423F3A423F3A3F3C373936312C282433332CDADBD6000000000000000000
0000000000000000004242420202001D1F1822211C28241F2A27222E2B26
312E2934312C3835303E3B3643403B45423D47443F4B48434C49444B4843
48454045423D43403B3F3C372E2A25383730DBDCD7000000000000000000
0000000000000000008989880000001F211A23221C28241F2B28232F2C27
33302B37342F3B3833403D3844413C4845404E4B464E4B444E4B414E4B43
4E4B4649464144413C413E392D2A2542413AE7E8E1000000000000000000
000000000000000000B6B7B60000001F211B23221C28241F2B28232E2B26
35322D3A37323E3B3643403B46433E4A4743514E4A504D454F4C41504D44
514E4A4B484446433F43403D25211D606058FDFEFB000000000000000000
000000000000000000EBEBEB16171211120C23221C28241F2B2823302D28
35322D3A37323F3C3743403B47443F4D4A44524F4A535047524F46535047
524F4A4E4B4648453E46443A15110A989791000000000000000000000000
00000000000000000000000067676800000026261E27231F2B2823302D28
35322D3A37323E3B3643403D49463E4E4B40514E45524F46555249545148
524F454F4C434A483A3D3C292A271BE1E0DF000000000000000000000000
000000000000000000000000E8E8E90D0E0915140D2925212B28232E2B26
33302B3835303F3C3743403C47443D4D4A3F4F4C42514E45524F45524F45
4F4C434E4A414C4A3F1A160E8C8784000000000000000000000000000000
00000000000000000000000000000091928F00000026221C2B28232F2C27
33302B3835303E3B36413E3944413C49463F4D4A43504D46504D47504D46
4D4A444D49442A291C444536FBFAFA000000000000000000000000000000
00000000000000000000000000000000000057565400000026231D302D28
312E2936332E3B38333E3B36423F3B45423E4845414C49454C49454C4945
4E4B462C282525251BDFE1D5000000000000000000000000000000000000
00000000000000000000000000000000000000000078767000000016130E
322F2933312B3835313A37343E3B36423F3944413B47443E4A464144403B
1B1813403C36D6D5D3000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000ACACAD282923
0000001011082A281E322F2738362C39382B3A382C312C221C1409251F16
6E6E6EF3F3F2000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000F6F7F5
999A975454502E2C20282619221F1725221D322F294B4944807E79CDCCC8
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000EBE7EBDAD5DBCFCBCDD4D0CFDED9D9FCFCFB000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
} #{
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFF0BB9FA09DADCEFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFCE
540A0000000000002A89
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFF86100
00000000000000000000
27AFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFF01E0000
00000000000000000000
000084FFFFFFFFFFFFFF
FFFFFFFFFFF51E000000
00000000000000000000
00000097FFFFFFFFFFFF
FFFFFFFFFF4800000000
00000000000000000000
00000000DAFFFFFFFFFF
FFFFFFFFC40000000000
00000000000000000000
0000000029FFFFFFFFFF
FFFFFFFF2C0000000000
00000000000000000000
0000000000C4FFFFFFFF
FFFFFFDA000000000000
00000000000000000000
00000000005CFFFFFFFF
FFFFFF91000000000000
00000000000000000000
00000000001AF4FFFFFF
FFFFFF74000000000000
00000000000000000000
000000000004D7FFFFFF
FFFFFF72000000000000
00000000000000000000
000000000002D4FFFFFF
FFFFFF70000000000000
00000000000000000000
000000000000D2FFFFFF
FFFFFF79000000000000
00000000000000000000
000000000007DBFFFFFF
FFFFFF9F000000000000
00000000000000000000
000000000026FBFFFFFF
FFFFFFE6000000000000
00000000000000000000
000000000068FFFFFFFF
FFFFFFFF3F0000000000
00000000000000000000
0000000000D1FFFFFFFF
FFFFFFFFDD0000000000
00000000000000000000
0000000047FFFFFFFFFF
FFFFFFFFFF6B00000000
00000000000000000000
00000000F2FFFFFFFFFF
FFFFFFFFFFFF36000000
00000000000000000000
000000B8FFFFFFFFFFFF
FFFFFFFFFFFFFF480000
00000000000000000000
0000B0FFFFFFFFFFFFFF
FFFFFFFFFFFFFFFF8C01
00000000000000000000
42DAFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFE8
833400000000000E53B3
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFE7CBCDCED9F7FFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
}]

white-chess:  make image! [30x30 #{
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000FFFFF7
FFFFF9000000000000000000000000000000000000000000000000FFFFF9
FFFFF8000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000FEFDFD
FFFFFF000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000FFFFFF
FFFFFC000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
FDFDFEDFE2D8C1BFB0B7B3A5B5B1A3B5B0A3BBB6A7C1C1B1D7DBD3F9F9FE
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000FFFEF5FFFFFD000000D7D4CE
A7A89694967E9B9982A39E8BA5A28EA8A590A8A490A3A089A0A089B2AEA1
D3D5C7FDFFF9000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000FAF8FAAFACA0908F76
A09F87ADAB97AFAE9BB0B09BB1B19CB4B49FB5B7A1B8B5A2BCB4A2B5AD98
A4A48CB4B7A8F2F2ED000000000000000000000000000000000000000000
000000000000000000FBFEF0FBFDF6000000F6F6F6A4A198939181AAA995
AEAD98B1B09CB4B39EB5B4A0B6B5A1B9B8A4BBBAA6BDBAA6BEB9A6BEB9A6
BFBAABB0AB9BB3AF9EEFF0EF000000000000000000000000000000000000
000000000000000000FDFFF5FFFFFDFFFFFFAAA59997967CADAD9AB0AD9C
B5B09DB7B3A0BAB5A2BCB8A5C0BBA8C3BEABC4BFACC4C0ADC5C0ADC5C0AD
C5BFADC6C0ADB8B39DB7B3A2F8F7F5000000000000000000000000000000
000000000000000000000000000000C7C6BB958E7FADAC98ACAE98B5B39E
BCB6A3BCB7A4BFBAA7C3BEABC6C1AEC7C2AFCAC5B2CCC7B4CDC8B5CDC8B6
CCC7B3C9C4B0C9C3B3B7B2A1CBCEB9FFFFFF000000000000000000000000
000000000000000000000000ECEDE8979881A9A495B0AE9CB2B19DB9B6A2
BEB8A5C1BCA9C5C0ADC9C4B1CCC7B4CDC8B5CFCAB7D3CEBBD4CFBCD5D0BD
D2CDBACFCAB6CDC6B9CCC6B7B7BA96E8E8E2000000FFFFFCFFFFF9000000
000000000000000000000000C3C1B2959387AFADA0B6B09DBCB6A3BEB9A6
C0BBA8C6C1AECAC5B2CDC8B5D2CDBAD4CFBCD8D3C0D9D4C1D9D4C1D9D4C1
D9D4C1D7D2BFD4CFBCD2CDBAC6BFA9D6D4C6000000FEFEFDFFFFFA000000
000000000000000000F6F7FBACAAA3A3A093B0AEA2B7B2A0BDB8A4C2BCA9
C5C0ADC9C4B1CEC9B6D3CEBBD8D3C0DCD7C4DDD8C5E1DCC9E2DDCAE3DECB
E0DBC8DDD8C5DBD6C3D7D2BFD1C9B7CACAB2F7FBF3000000000000000000
000000FFFFFB000000EEEEEDA4A494ABA998B2B1A0BAB5A2BFB9A6C4BFAC
CAC5B2CEC9B6D3CEBBD9D4C1DED9C6E0DBC8E3DECBE6E1CEE6E1CEE6E1CE
E6E1CEE2DDCAE0DBC8DDD8C5D8D2C0CBC8B0ECECE1000000000000000000
000000FFFFFB000000E7E9E3A0A089AEAD97B5B49FBCB8A4C2BDAAC7C2AF
CDC8B5D3CEBBDAD5C2DFDAC7E2DDCAE5E0CDE9E4D1ECE7D4EBE6D3EBE6D3
ECE7D4E8E3D0E4DFCCE1DCC9DED9C6D1CAB6EBE5DF000000000000000000
000000FFFFFA000000E6E8E3A0A08CB0AF9AB8B7A3BFBAA7C6C0ADCBC6B3
CFCAB7D6D1BEDED9C6E3DECBE6E1CEECE7D4F0EBD8F2EDDAF2EDDAF2EDDA
F2EDDAEFEAD7EBE6D3E5E0CDE2DDCAD5D0BAEDE9E4000000000000000000
000000FFFFFB000000E9EAE6A3A38EB1B09BB7B6A2C0BBA8C9C3B1CCC7B4
D2CDBADAD5C2E0DBC8E6E1CEECE7D4F2EDDAF4EFDCF6F1DEF7F2DFF7F2DF
F6F1DEF4EFDCF1ECD9EBE6D3E5E0CDD7D3BDEEEDE7000000000000000000
000000FFFFFB000000F1F2EFAAAA95B1B09BB8B8A3C1BDA9C9C4B1CEC9B6
D6D1BEDDD8C5E3DECBE8E3D0EEE9D6F4EFDCF6F1DEF9F4E1FCF7E4FCF7E4
F8F3E0F6F1DEF3EEDCEDE8D6E7E2D0DCD9C2F3F3EB000000FAFFFC000000
000000FFFFFC000000FEFDFAB8BAA4ABAB93BCB9A8C3BEABC8C3B0CEC9B6
D6D1BEDFDAC7E5E0CDEBE6D3F1ECD9F6F1DEF9F4E1FBF6E3FCF7E4FCF7E4
FBF6E3F9F4E1F5F0DDF0EBD8E8E3CDE4E1C9FBFBF8000000FAFFFB000000
000000000000000000000000CFD4C4A0A289BFB8ADC4BEADC8C3B0CEC9B6
D6D1BEDDD8C5E4DFCCEBE6D3F2EDDAF4EFDCF9F4E1FDF8E5FEF9E6FFFAE7
FDF8E5F9F4E1F4EFDCF2EDD7E6E0C3E8E7D8000000000000000000000000
000000000000000000000000F4F5F6AEAD9AB9B2A2C2BDABC7C2AFCEC9B6
D6D1BEDED9C6E4DFCCEAE5D2F0EBD8F6F1DEFAF5E2FCF7E4FCF7E4FCF7E4
FCF7E4F9F4E1F5EFE0EFEBD0E7E2C6FAF2F9000000000000000000000000
000000000000000000000000000000D9D9D3A7A78FC2BEA9C9C4B1CFCAB7
D6D1BEDED9C6E3DECBE8E3D0EDE8D6F3EEDBF7F2DFF8F3E0F9F4E1F9F4E1
F8F3E0F6F2DEF3EDDBE5E1C8EFEEE0000000000000000000000000000000
000000000000000000000000000000FFFFFFBFC3B2B0AC95CAC4B1CDC8B5
D4CFBCDCD7C4E0DBC8E5E0CEECE7D4F1ECD9F4EFDCF6F1DEF7F2DFF7F2DF
F6F1DFF4EEDCEBE5D1E9E4D6FDFDFB000000000000000000000000000000
000000000000000000FEFEF7FFFEF9000000FDFDFAC7C3AEB4AF99CBC6B1
D3CEBCD7D2BFDED9C6E3DECAE8E3D0EDE8D5F1ECD8F3EDDBF2ECDBF2ECDA
F3EED9E9E4CDEAE4D2FDF9FB000000FEFFFA000000000000000000000000
000000000000000000000000FFFFF9000000000000FFFFFED2D6C6B6B5A0
C4BDACD2CDB6DBD7BEDFDBC2E2DEC6E8E3D0EAE5D3EDE8D4EEE9D2EBE6CC
E3E2C4ECEBD7FFFDF8000000000000FEFFFA000000000000000000000000
000000000000000000000000000000000000000000000000000000ECEDE5
D1D1BEC4C6AECBC7B3D4CEBBDDD8C5E2DDCAE2DCCADFDDC5DEE1C5E8E9D4
F4F5ED000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000FFFFF9FFFFF9FFFFFD000000
000000F1F4F2E6E1D6DBD3C6D8D2C4DCD7C4E5DFCBEDEDD9F5F9F1000000
000000FCFFFDF9FFF8FAFFF8000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000
} #{
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFF4
ECFFFFFFFFFFFFFFFFEC
F6FFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFF7
F9FFFFF5F3F3F4FDFFFB
FAFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
F787241112120E2881EE
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFF7F4FF73
00000000000000000000
49C7FFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFC70300
00000000000000000000
0000A1FFFFFFFFFFFFFF
FFFFFFFFFDFFC9050000
00000000000000000000
000000AEFFFFFFFFFFFF
FFFFFFFDECE708000000
00000000000000000000
00000000C2FFFFFFFFFF
FFFFFFFFFF3D00000000
00000000000000000000
000000001DFCFFFFFFFF
FFFFFFFFA90000000000
00000000000000000000
000000000096FFFCFCFF
FFFFFFFF440000000000
00000000000000000000
00000000003FFFF7F3FF
FFFFFFFB1E0000000000
00000000000000010202
010000000000B2FFFFFF
FFFAFFC3000000000000
00000000000002040404
04020000000089FFFFFF
FFF3FFAE000000000000
00000000020303030303
03030402000095FFFFFF
FFF5FFAC000000000000
00000002030303030303
03030303010092FFFFFF
FFF5FFB1000000000000
00000103030303030303
03030303020092FFFFFF
FFF4FFB7000000000000
00000203030303030303
0303030303009DFFFCFF
FFF9FFE20F0000000000
00010303030303030303
030303030000C2FFFFFF
FFFFFFFF5F0000000000
00000303030303030303
030303000057FFFFFFFF
FFFFFFFFD20000000000
00000303030303030303
03010B0100C3FFFFFFFF
FFFFFFFFFF6F00000000
00000203030303030303
030206006AFFFFFFFFFF
FFFFFFFFFFFE1D000000
00000003030303020303
03020017E5FFFFFFFFFF
FFFFFFFEF0FFCB000000
00000002030303040403
010002E4FFF2FFFFFFFF
FFFFFFFFFDFFFFE63200
00000000010403050200
0013B4FFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFF9F
0C000000000000000018
97FFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFEF3FFFF
FFC8645154555151A7FF
FFFEF2FFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
FFFFFFFFFFFFFFFFFFFF
}]


;单子价值算法
mark: func [ t [tuple!] turn [logic!] /turn-index] [       ;将棋子情况转换为字符
	either (t/1 = 0) and (t/2 = 0) [
		return "0"
	] [
		either turn [turn-index: 1] [turn-index: 0]
		either (t/1 = turn-index) [
			return "9"
		] [
			return "1"
		]
	]
]

val: func [ ord [integer!] turn [logic!] /local x y p mk value ] [
	x: (mod (ord - 1) 15) + 1                                             ;计算出棋子坐标
	y: (round/ceiling (ord - 1) / 15) + 1
	p: to-pair reduce[ x  y ]
	
	;----------------------------------------------------------
	bs-str: copy ""
	append bs-str "1"
	
	
	foreach z [1 2 3 4] [                                                   ;获取反斜杠方向棋子排列
		either (( x - z) >= 1) and ((y - z) >= 1) [
			mk: mark record/(to-pair reduce [ (x - z) (y - z) ]) turn
			insert bs-str mk
			if mk = "9" [break]
			
		] [
			insert bs-str "9"
			break
		]	
	]
	foreach z [1 2 3 4] [
		either (( x + z) <= 15) and ((y + z) <= 15) [
			mk: mark record/(to-pair reduce [ (x + z) (y + z) ]) turn
			append bs-str mk
			if mk = "9" [break]
		] [
			insert bs-str "9"
			break
		]
	]
	
	;----------------------------------------------------------
	s-str: copy ""                                                ;获取斜杠方向棋子排列
	append s-str "1"
	
	foreach z [1 2 3 4] [
		either (( x - z) >= 1) and ((y + z) <= 15) [
			mk: mark record/(to-pair reduce [ (x - z) (y + z) ]) turn
			insert s-str mk
			if mk = "9" [break]
		] [
			insert s-str "9"
			break
		]
	]
	foreach z [1 2 3 4] [
		either (( x + z) <= 15) and ((y - z) >= 1) [
			mk: mark record/(to-pair reduce [ (x + z) (y - z) ]) turn
			append s-str mk
			if mk = "9" [break]
		] [
			insert s-str "9"
			break
		]
	]
	
	;----------------------------------------------------------
	h-str: copy ""                                            ;获取横向棋子排列
	append h-str "1"
	
	foreach z [1 2 3 4] [
		either (x - z) >= 1 [
			mk: mark record/(to-pair reduce [ (x - z) y ]) turn
			insert h-str mk
			if mk = "9" [break]
		] [
			insert h-str "9"
			break
		]
	]
	foreach z [1 2 3 4] [
		either (x + z) <= 15 [
			mk: mark record/(to-pair reduce [ (x + z) y ]) turn
			append h-str mk
			if mk = "9" [break]
		] [
			insert h-str "9"
			break
		]
	]
	
	;----------------------------------------------------------
	v-str: copy ""                                          ;获取反竖向棋子排列
	append v-str "1"
	
	foreach z [1 2 3 4] [
		either (y - z) >= 1 [
			mk: mark record/(to-pair reduce [ x (y - z) ]) turn
			insert v-str mk
			if mk = "9" [break]
		] [
			insert v-str "9"
			break
		]
	]
	foreach z [1 2 3 4] [
		either (y + z) <= 15 [
			mk: mark record/(to-pair reduce [ x (y + z) ]) turn
			append v-str mk
			if mk = "9" [break]
		] [
			insert v-str "9"
			break
		]
	]
	
	;----------------------------------------------------------
	bs-str: rejoin ["9" bs-str "9"]                    ;两端加上界定字符
	s-str: rejoin ["9" s-str "9"]
	h-str: rejoin ["9" h-str "9"]
	v-str: rejoin ["9" v-str "9"]


	;价值计算规则：边界或反子直接接着正子，正子不计价值
	;其余每个正子价值+1，正子之间空格每个价值-0.5
	;记录最高价值和总价值，四舍五入取整
	
	value: 0
	tot-value: 0
	v-rule: [
		( v: 0)
		[ some "9" 5 "1" (v: 10) | some "9" some "0" "1" (v: 1) | some "9" "1" (v: v - 1)  ]
		[	
			[ some "0" some "9" | some "9" (v: v - 1) ] |
			some [ "1" (v: v + 1 if v >= 5 [v: 10]) ] [ some "0" some "9" | some "9" (v: v - 1) ] |
			some [ 
				[ some "0" some "9" | some "9" (v: v - 1) ] |
				some [ "0" (v: v - 0.5 )] 
				some [ "1" (v: v + 1 if v >= 5 [v: 10]) ]
			]   	
		]
		(value: max value round/half-ceiling v tot-value: tot-value + v)
	]
	
	parse bs-str v-rule
	parse s-str v-rule
	parse h-str v-rule
	parse v-str v-rule 
	
	if (tot-value < 0) [ tot-value: 0 ]
	
	return to-pair reduce [ value tot-value]  ;返回最高价值和总价值
] 

;价值算法
val-alg: func[ turn [logic!] /local thr value thr-blk val-blk most-thr most-val choice] [
	
	val-blk: copy [] 	;计算每一个空格下正子的价值
	i: 1
	while [i <= 225] [
		if (record/:i/1 = 0) and (record/:i/2 = 0) [
			value: val i turn
			append val-blk to-tuple reduce [value/1 value/2 i]
			if (value/1 >= 5) [return i]
		]
		i: i + 1
	]
	sort val-blk
	
	thr-blk: copy []                              ;计算每一个空格下反子的价值，也即威胁值
	i: 1
	while [i <= 225] [
		if (record/:i/1 = 0) and (record/:i/2 = 0) [
			thr: val i not turn
			append thr-blk to-tuple reduce [thr/1 thr/2 i]
			if (thr/1 >= 5) [return i]
		]
		i: i + 1
	]
	sort thr-blk
	
	most-val: pick val-blk (length? thr-blk)      ;通过之前的排序，获取最高价值和最高威胁值
	most-thr: pick thr-blk (length? thr-blk)
	
	
	
	choice-blk: copy []
	random/seed now
												  ;根据最高价值和最高威胁值的情况决定下子决策
	either ((most-thr/1 > most-val/1) and (most-thr/1 >= 3)) or (index = 2) [
		x: (length? thr-blk)
		while [x >= 1] [
			either (thr-blk/:x/1 = most-thr/1) [
				if (thr-blk/:x/2 = most-thr/2) [
					append choice-blk thr-blk/:x
				]
				if (thr-blk/:x/2 > most-thr/2) [
					choice-blk: copy []
					append choice-blk thr-blk/:x
				]
			] [
				break
			]
			x: x - 1
		]
		choice: take random choice-blk
	] [
		x: (length? val-blk)
		while [x >= 1] [
			either (val-blk/:x/1 = most-val/1) [
				if (val-blk/:x/2 = most-val/2) [
					append choice-blk val-blk/:x
				]
				if (val-blk/:x/2 > most-val/2) [
					choice-blk: copy []
					append choice-blk val-blk/:x
				]
			] [
				break
			]
			x: x - 1
		]	
		choice: take random choice-blk              ;根据最高值和总值，获取最优选择，如有多个选择，随机选取
	] 
	return choice/3
]

;模拟点击事件
click: func [ ord [integer!] turn [logic!]] [
	either turn [
		do rejoin [ "C" ord {/image: black-chess} ]
		do rejoin [ "poke record C" ord {/data to-tuple reduce [0 1 index 0]} ]
		do rejoin [ "poke trait C" ord {/data to-tuple reduce [0 1 index 0]} ]
		do rejoin [ "show C" ord ]
	] [
		do rejoin [ "C" ord {/image: white-chess} ]
		do rejoin [ "poke record C" ord {/data to-tuple reduce [1 0 index 0]} ]
		do rejoin [ "poke trait C" ord {/data to-tuple reduce [1 0 0 0]} ]
		do rejoin [ "show C" ord ]
	]
	
]


index: 1
record: make image! [15x15 0.0.0]     ;创建记录棋谱
trait: make image! [15x15 0.0.0]      ;创建特征棋谱，用于匹配
myturn: true                          ;控制黑白子顺序

;--------------------------------------------------------------------------

view [
	title "Gobang"
	style qbox: base 30x30 238.180.34  
	on-up [
		if face/image = none  [           ;点击事件，图像为空时，根据下子顺序显示黑白子
			if myturn [
				face/image: black-chess
				poke record face/data to-tuple reduce [0 1 index 0]   ;更新记录棋谱
				poke trait face/data to-tuple reduce [0 1 0 0]    ;更新特征棋谱
				show face 
				v: val face/data myturn 				;计算单子价值
				
				v: v/1
				if (v >= 5) [                                     ;获胜判定和清空棋盘
					view/flags alert: layout [text "Black Win!" button "OK" [unview alert] focus] [ modal ]
					i: 1
					while [i <= 225] [
						do rejoin reduce [ "C" i {/image: none}]
						do rejoin reduce [ {show C} i ]	
						i: i + 1
					]
					record: make image! [15x15 0.0.0] 
					trait: make image! [15x15 0.0.0] 
					myturn: not myturn
				]
				myturn: not myturn
				
				index: index + 1
			]
			if (not myturn) [
				choice: val-alg myturn                            ;价值算法进行下子决策
				click choice myturn
				v: val choice myturn
				v: v/1
				if (v >= 5) [
					view/flags alert: layout [text "White Win!" focus button "OK" [unview alert] focus] [ modal ]
					i: 1
					while [i <= 225] [
						do rejoin reduce [ "C" i {/image: none}]
						do rejoin reduce [ {show C} i ]		
						i: i + 1
					]
					record: make image! [15x15 0.0.0] 
					trait: make image! [15x15 0.0.0] 
				]
				myturn: not myturn
				index: index + 1
			]		
			
		] 
	]
	
	

	origin 0x0
	panel 466x466 black [
		origin 1x1
		space 1x1
		C1: qbox with [data: 1]
		C2: qbox with [data: 2]
		C3: qbox with [data: 3]
		C4: qbox with [data: 4]
		C5: qbox with [data: 5]
		C6: qbox with [data: 6]
		C7: qbox with [data: 7]
		C8: qbox with [data: 8]
		C9: qbox with [data: 9]
		C10: qbox with [data: 10]
		C11: qbox with [data: 11]
		C12: qbox with [data: 12]
		C13: qbox with [data: 13]
		C14: qbox with [data: 14]
		C15: qbox with [data: 15]
		return
		C16: qbox with [data: 16]
		C17: qbox with [data: 17]
		C18: qbox with [data: 18]
		C19: qbox with [data: 19]
		C20: qbox with [data: 20]
		C21: qbox with [data: 21]
		C22: qbox with [data: 22]
		C23: qbox with [data: 23]
		C24: qbox with [data: 24]
		C25: qbox with [data: 25]
		C26: qbox with [data: 26]
		C27: qbox with [data: 27]
		C28: qbox with [data: 28]
		C29: qbox with [data: 29]
		C30: qbox with [data: 30]
		return
		C31: qbox with [data: 31]
		C32: qbox with [data: 32]
		C33: qbox with [data: 33]
		C34: qbox with [data: 34]
		C35: qbox with [data: 35]
		C36: qbox with [data: 36]
		C37: qbox with [data: 37]
		C38: qbox with [data: 38]
		C39: qbox with [data: 39]
		C40: qbox with [data: 40]
		C41: qbox with [data: 41]
		C42: qbox with [data: 42]
		C43: qbox with [data: 43]
		C44: qbox with [data: 44]
		C45: qbox with [data: 45]
		return
		C46: qbox with [data: 46]
		C47: qbox with [data: 47]
		C48: qbox with [data: 48]
		C49: qbox with [data: 49]
		C50: qbox with [data: 50]
		C51: qbox with [data: 51]
		C52: qbox with [data: 52]
		C53: qbox with [data: 53]
		C54: qbox with [data: 54]
		C55: qbox with [data: 55]
		C56: qbox with [data: 56]
		C57: qbox with [data: 57]
		C58: qbox with [data: 58]
		C59: qbox with [data: 59]
		C60: qbox with [data: 60]
		return
		C61: qbox with [data: 61]
		C62: qbox with [data: 62]
		C63: qbox with [data: 63]
		C64: qbox with [data: 64]
		C65: qbox with [data: 65]
		C66: qbox with [data: 66]
		C67: qbox with [data: 67]
		C68: qbox with [data: 68]
		C69: qbox with [data: 69]
		C70: qbox with [data: 70]
		C71: qbox with [data: 71]
		C72: qbox with [data: 72]
		C73: qbox with [data: 73]
		C74: qbox with [data: 74]
		C75: qbox with [data: 75]
		return
		C76: qbox with [data: 76]
		C77: qbox with [data: 77]
		C78: qbox with [data: 78]
		C79: qbox with [data: 79]
		C80: qbox with [data: 80]
		C81: qbox with [data: 81]
		C82: qbox with [data: 82]
		C83: qbox with [data: 83]
		C84: qbox with [data: 84]
		C85: qbox with [data: 85]
		C86: qbox with [data: 86]
		C87: qbox with [data: 87]
		C88: qbox with [data: 88]
		C89: qbox with [data: 89]
		C90: qbox with [data: 90]
		return
		C91: qbox with [data: 91]
		C92: qbox with [data: 92]
		C93: qbox with [data: 93]
		C94: qbox with [data: 94]
		C95: qbox with [data: 95]
		C96: qbox with [data: 96]
		C97: qbox with [data: 97]
		C98: qbox with [data: 98]
		C99: qbox with [data: 99]
		C100: qbox with [data: 100]
		C101: qbox with [data: 101]
		C102: qbox with [data: 102]
		C103: qbox with [data: 103]
		C104: qbox with [data: 104]
		C105: qbox with [data: 105]
		return
		C106: qbox with [data: 106]
		C107: qbox with [data: 107]
		C108: qbox with [data: 108]
		C109: qbox with [data: 109]
		C110: qbox with [data: 110]
		C111: qbox with [data: 111]
		C112: qbox with [data: 112]
		C113: qbox with [data: 113]
		C114: qbox with [data: 114]
		C115: qbox with [data: 115]
		C116: qbox with [data: 116]
		C117: qbox with [data: 117]
		C118: qbox with [data: 118]
		C119: qbox with [data: 119]
		C120: qbox with [data: 120]
		return
		C121: qbox with [data: 121]
		C122: qbox with [data: 122]
		C123: qbox with [data: 123]
		C124: qbox with [data: 124]
		C125: qbox with [data: 125]
		C126: qbox with [data: 126]
		C127: qbox with [data: 127]
		C128: qbox with [data: 128]
		C129: qbox with [data: 129]
		C130: qbox with [data: 130]
		C131: qbox with [data: 131]
		C132: qbox with [data: 132]
		C133: qbox with [data: 133]
		C134: qbox with [data: 134]
		C135: qbox with [data: 135]
		return
		C136: qbox with [data: 136]
		C137: qbox with [data: 137]
		C138: qbox with [data: 138]
		C139: qbox with [data: 139]
		C140: qbox with [data: 140]
		C141: qbox with [data: 141]
		C142: qbox with [data: 142]
		C143: qbox with [data: 143]
		C144: qbox with [data: 144]
		C145: qbox with [data: 145]
		C146: qbox with [data: 146]
		C147: qbox with [data: 147]
		C148: qbox with [data: 148]
		C149: qbox with [data: 149]
		C150: qbox with [data: 150]
		return
		C151: qbox with [data: 151]
		C152: qbox with [data: 152]
		C153: qbox with [data: 153]
		C154: qbox with [data: 154]
		C155: qbox with [data: 155]
		C156: qbox with [data: 156]
		C157: qbox with [data: 157]
		C158: qbox with [data: 158]
		C159: qbox with [data: 159]
		C160: qbox with [data: 160]
		C161: qbox with [data: 161]
		C162: qbox with [data: 162]
		C163: qbox with [data: 163]
		C164: qbox with [data: 164]
		C165: qbox with [data: 165]
		return
		C166: qbox with [data: 166]
		C167: qbox with [data: 167]
		C168: qbox with [data: 168]
		C169: qbox with [data: 169]
		C170: qbox with [data: 170]
		C171: qbox with [data: 171]
		C172: qbox with [data: 172]
		C173: qbox with [data: 173]
		C174: qbox with [data: 174]
		C175: qbox with [data: 175]
		C176: qbox with [data: 176]
		C177: qbox with [data: 177]
		C178: qbox with [data: 178]
		C179: qbox with [data: 179]
		C180: qbox with [data: 180]
		return
		C181: qbox with [data: 181]
		C182: qbox with [data: 182]
		C183: qbox with [data: 183]
		C184: qbox with [data: 184]
		C185: qbox with [data: 185]
		C186: qbox with [data: 186]
		C187: qbox with [data: 187]
		C188: qbox with [data: 188]
		C189: qbox with [data: 189]
		C190: qbox with [data: 190]
		C191: qbox with [data: 191]
		C192: qbox with [data: 192]
		C193: qbox with [data: 193]
		C194: qbox with [data: 194]
		C195: qbox with [data: 195]
		return
		C196: qbox with [data: 196]
		C197: qbox with [data: 197]
		C198: qbox with [data: 198]
		C199: qbox with [data: 199]
		C200: qbox with [data: 200]
		C201: qbox with [data: 201]
		C202: qbox with [data: 202]
		C203: qbox with [data: 203]
		C204: qbox with [data: 204]
		C205: qbox with [data: 205]
		C206: qbox with [data: 206]
		C207: qbox with [data: 207]
		C208: qbox with [data: 208]
		C209: qbox with [data: 209]
		C210: qbox with [data: 210]
		return
		C211: qbox with [data: 211]
		C212: qbox with [data: 212]
		C213: qbox with [data: 213]
		C214: qbox with [data: 214]
		C215: qbox with [data: 215]
		C216: qbox with [data: 216]
		C217: qbox with [data: 217]
		C218: qbox with [data: 218]
		C219: qbox with [data: 219]
		C220: qbox with [data: 220]
		C221: qbox with [data: 221]
		C222: qbox with [data: 222]
		C223: qbox with [data: 223]
		C224: qbox with [data: 224]
		C225: qbox with [data: 225]
	
	]
]